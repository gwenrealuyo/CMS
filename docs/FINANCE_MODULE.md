# Finance Module Guide

## Data Model & Storage

### Donation Model

- `apps.finance.models.Donation` captures free-will giving with:
  - Amount (decimal, max 10 digits, 2 decimal places)
  - Date (the donation date)
  - Purpose (string, e.g., "Tithe", "Offering", "Building Fund", "Missions")
  - Payment method (choice: CASH, CHECK, BANK_TRANSFER, CARD, DIGITAL_WALLET; defaults to CASH)
    - **CARD**: Previously labeled as "ONLINE", renamed to "Card" for clarity
    - **DIGITAL_WALLET**: Added as a payment option for digital wallet transactions
  - Optional donor (ForeignKey to `people.Person` for linked members)
  - Unique `receipt_number` (string, max 50 chars) – must be unique across all donations
    - Format: `REC-` prefix followed by 6-digit zero-padded number (e.g., `REC-001000`)
    - Auto-generated by frontend form if not provided
  - `is_anonymous` (boolean) – flags donations without donor attribution
  - Notes (text field for additional details)
  - Audit fields: `recorded_by` (staff who logged it), `created_at` (timestamp)
- Default ordering: newest-first by `-date`, then `-created_at`
- The `receipt_number` uniqueness constraint ensures no duplicate receipt numbers can exist

### Offering Model

- `apps.finance.models.Offering` records weekly service offerings with:
  - `service_date` (date, defaults to today)
  - `service_name` (string, e.g., "Sunday AM Service", "Midweek Service")
  - Optional `fund` (string for fund designation like "General Fund", "Building Fund")
    - Defaults to "General Fund" in the form
  - Amount (decimal)
  - Notes (text)
  - Audit: `recorded_by`, `created_at`
- Default ordering: newest-first by `-service_date`, then `-created_at`
- Supports full CRUD operations (create, read, update, delete)

### Pledge Model

- `apps.finance.models.Pledge` tracks campaign commitments:
  - Optional pledger (ForeignKey to `people.Person`)
  - `pledge_title` (short description of the pledge)
  - `pledge_amount` (target amount)
  - `amount_received` (cached total, auto-updated from contributions)
  - Status (ACTIVE, FULFILLED, CANCELLED; defaults to ACTIVE)
  - `start_date` (when the pledge began, defaults to today)
  - Optional `target_date` (deadline for fulfillment)
  - Optional `purpose` (string for categorization)
  - Notes (text)
  - Audit: `recorded_by`, `created_at`, `updated_at`
- **Computed Properties**:
  - `balance`: Returns `pledge_amount - effective_amount_received()` (calculated from contributions)
  - `progress_percent`: Returns percentage of fulfillment (0-100)
  - `effective_amount_received()`: Returns total from contributions (falls back to cached `amount_received` if no contributions exist)
- **Helper Methods**:
  - `contributions_total()`: Aggregates all related contributions using Django aggregation
  - `refresh_amount_received(commit=True)`: Recalculates and saves `amount_received` from contributions
- Default ordering: by `status`, then `target_date`, then `pledge_title`
- When creating a pledge with `amount_received > 0`, an initial contribution record is automatically created to preserve history

### PledgeContribution Model

- `apps.finance.models.PledgeContribution` captures each installment toward a pledge:
  - `pledge` (ForeignKey to Pledge, CASCADE delete)
  - **`contributor`** (optional ForeignKey to `people.Person`) – Person who made this contribution payment
    - Distinct from `recorded_by` (staff who logged it)
    - Allows tracking contributions from different people (e.g., family members) even if they're part of the same pledge
    - Nullable and optional
  - `amount` (decimal)
  - `contribution_date` (date, defaults to today)
  - Optional `note` (text)
  - Audit: `recorded_by` (staff who logged it), `created_at`, `updated_at`
- Default ordering: newest-first by `-contribution_date`, then `-created_at`
- **Cascade Behavior**: Deleting a pledge automatically deletes all its contributions
- **Auto-Refresh**: When contributions are created, updated, or deleted, the parent pledge's `amount_received` is automatically refreshed via the viewset's `perform_create`, `perform_update`, and `perform_destroy` methods

### Audit Pattern

All models share the `recorded_by` audit pattern (ForeignKey to `people.Person`) so staff attribution is preserved even if the donor/pledger is anonymous. The field is nullable and uses `SET_NULL` on delete to preserve historical records.

### Migrations

- `apps.finance.migrations.0001_initial` – Creates Donation, Offering, and Pledge tables with basic relationships
- `apps.finance.migrations.0002_pledgecontribution` – Creates PledgeContribution model with foreign keys, indexes, and the `contributor` field
- `apps.finance.migrations.0003_alter_donation_payment_method_and_more` – Updates payment method choices and recorded_by help text

There is no seed data in migrations; use the management command for sample data.

## Aggregations & Services

- `apps.finance.services.weekly_offering_totals(start=None, end=None)` aggregates offerings by ISO week using `TruncWeek`, returning `[{week_start, total_amount}]` for dashboards. The range is optional.
- `apps.finance.services.pledge_summaries(status=None)` now annotates each pledge with contribution totals, `balance`, and `progress_percent` and filters by status list when supplied.
- Both helpers are surfaced via custom viewset actions so the frontend can fetch summary cards without duplicating logic.

## API Surface

All routes live under `/api/finance/` (namespaced in `core.urls`):

### Donations

- `/api/finance/donations/` – DonationViewSet CRUD with optional date filtering via `?start=YYYY-MM-DD&end=YYYY-MM-DD`. `POST` automatically stamps `recorded_by` with the authenticated user when available. Donations are filtered by `date` field when date range parameters are provided.

### Offerings

- `/api/finance/offerings/` – OfferingViewSet CRUD with optional date filtering via `?start=YYYY-MM-DD&end=YYYY-MM-DD`. Filtering uses the `service_date` field. Full CRUD operations are supported (create, read, update, delete).
- `/api/finance/offerings/{id}/` – `PUT` endpoint for updating individual offerings
- `/api/finance/offerings/weekly_summary/` – `GET` action returning the `weekly_offering_totals` payload (aggregated by ISO week). Accepts optional `start`, `end` (ISO date strings).

### Pledges

- `/api/finance/pledges/` – PledgeViewSet CRUD. Accepts `?status=ACTIVE&status=FULFILLED` filters for list view (multiple status values can be provided). Responses include `contributions_total`, `balance`, and `progress_percent` computed from contributions. When creating a pledge with an `amount_received` value, an initial contribution record is automatically created to preserve history.
- `/api/finance/pledges/{id}/` – `PUT` endpoint for updating individual pledges. Automatically refreshes `amount_received` from contributions after update.
- `/api/finance/pledges/summary/` – `GET` action returning condensed pledge metrics (`id`, `pledge_title`, `pledge_amount`, `amount_received`, `balance`, `progress_percent`, `status`). Accepts optional `?status=ACTIVE` filter.

### Pledge Contributions

- `/api/finance/pledge-contributions/` – ViewSet to list, create, update, and delete pledge installments. Supports filtering via:
  - `?pledge={pledge_id}` – contributions for a specific pledge
  - `?start=YYYY-MM-DD&end=YYYY-MM-DD` – contributions within a date range (uses `contribution_date`)
- **`POST`** requires `pledge`, `amount`, `contribution_date`, and optionally `contributor` (person ID). Automatically refreshes the parent pledge's `amount_received` total.
- **`PUT/PATCH`** allows updating contribution fields (amount, date, contributor, note). Automatically refreshes the parent pledge's totals after update.
- **`DELETE`** removes a contribution and automatically refreshes the parent pledge's totals.
- **`GET`** returns all contributions with related pledge, contributor, and recorded_by information.

### Serializers

Serializers (`apps.finance.serializers`) expose helper fields such as:
- `recorded_by_name` – Full name of staff who logged the entry
- `contributor_name` – Full name of person who made the contribution (PledgeContribution only)
- `balance` – Remaining balance for pledges
- `progress_percent` – Fulfillment percentage for pledges

All date filtering on the backend uses `date__gte` and `date__lte` (or equivalent field) filtering.

## Frontend Behavior

The Finance hub lives at `frontend/src/app/finance/page.tsx` and provides a comprehensive view of all financial activity.

### Date Filtering

The page supports flexible date range filtering with multiple preset periods and a custom range option:

- **Preset Periods**: 
  - **This Week**: Monday to Sunday of current week
  - **This Month**: First to last day of current month
  - **This Year**: January 1 to December 31 of current year
  - **Last 7 Days**: Rolling 7 days from today
  - **Last 30 Days**: Rolling 30 days from today
  - **Last Quarter**: Rolling 90 days from today
  - **Last 6 Months**: Rolling 180 days from today
  - **Previous Month**: Complete previous calendar month
  - **Previous Year**: Complete previous calendar year
- **Custom Range**: Allows selecting any start and end date via date pickers. Date inputs appear when "Custom Range" is selected from the dropdown.
- **Default**: "This Month" is selected by default on page load
- **Effect**: All data (donations, offerings, pledge contributions) is filtered by the selected date range, and summary cards update accordingly
- **UI**: The date range selector is positioned on the left side of the overview stats header, with the dropdown showing all available periods

The date range applies to:
- Donations (`date` field)
- Offerings (`service_date` field)
- Pledge contributions (`contribution_date` field)
- Weekly offering summaries

### Components Overview

- **`FinanceOverviewStats`**: Top-level snapshot showing unified metrics across all finance types in 4 consolidated cards:
  - **Total Collected**: Sum of donations, offerings, and pledge contributions within the date range
  - **Total Committed**: Total amount pledged across all active pledges
  - **Outstanding Balance**: Remaining balance to fulfill pledges (from contributions in the date range)
  - **Total Activity**: Count of all transactions (donations + offerings + pledges with contributions)
  - Includes the date range selector dropdown on the left side of the header
  - Cards use white background with shadow for consistent styling

- **`DonationStats`**: Detailed donation metrics card showing:
  - **Total Giving**: Sum of all donations in the filtered period
  - **Average Per Entry**: Mean donation amount
  - **Entries Recorded**: Count of donations
  - **Purpose Mix**: Visual breakdown of donations by purpose (Tithe, Offering, Building Fund, Missions, etc.) with:
    - Amount per purpose
    - Percentage of total with progress bars
    - Sorted by amount (highest first)
    - Full-width card layout

- **`OfferingTable`**: Lists all offerings within the date range with sortable columns:
  - **Service**: Service name and date (clickable to edit)
  - **Fund**: Fund designation
  - **Amount**: Offering amount
  - **Recorded By**: Staff member who recorded the offering
  - **Sortable Columns**: All columns support sorting (default: service date descending)
  - **Edit Functionality**: Clicking the service name opens the edit form
  - Supports adding new offerings via "Record Offering" button

- **`OfferingSummaryCard`**: Weekly aggregation view showing offering totals grouped by ISO week with week start dates and total amounts.

- **`PledgeTable`**: Displays all pledges with status badges, progress bars showing fulfillment percentage, pledge amounts, received amounts, and balances:
  - **Sortable Columns**: All columns support sorting (default: pledge title ascending)
    - Pledge (by title)
    - Status (alphabetical)
    - Amount (numerical)
    - Received (numerical)
    - Balance (numerical)
    - Progress (numerical)
  - **Clickable Pledge Names**: Clicking a pledge name opens the contribution management modal
  - **Edit Button**: "Edit" button in the Actions column opens the pledge edit form
  - **Add Pledge**: "Add Pledge" button creates a new pledge

- **Pledge Snapshot Card**: Quick reference showing total pledged, total received, and outstanding balance for all pledges (only includes pledges with contributions in the date range).

- **Contribution Management Modal**: When managing contributions for a pledge, admins can:
  - View all historical contributions for that pledge in a table showing:
    - Date, Contributor, Amount, Recorded By, Notes
    - Clickable rows to edit contributions
  - **Add new contribution installments** with:
    - Amount (required)
    - Contribution date (required)
    - Contributor selection (optional dropdown of people)
    - Notes (optional)
  - **Edit contributions** by clicking on any contribution row or the Edit button:
    - All fields are editable (amount, date, contributor, notes)
    - Updates automatically refresh pledge totals
  - **Delete contributions** via the Remove button (automatically updates pledge totals)
  - See contribution totals and updated pledge progress in real-time

### Forms

All three forms (`DonationForm`, `OfferingForm`, `PledgeForm`) seed sensible defaults and support both create and edit modes:

- **DonationForm**: 
  - Auto-generates receipt numbers in `REC-` format with 6-digit zero-padded numbers (e.g., `REC-000123`)
  - Defaults to current date
  - Pre-fills common payment methods and purposes
  - Payment methods include: Cash, Check, Bank Transfer, **Card** (previously "Online"), **Digital Wallet**

- **OfferingForm**: 
  - Defaults to today's date and common service names
  - **Fund field**: Pre-filled with "General Fund" by default
  - Supports editing existing offerings (form prefills with offering data when `initialData` is provided)
  - Modal title changes to "Edit Offering" when editing

- **PledgeForm**: 
  - Defaults to current date, ACTIVE status, and empty contribution fields
  - **Pledge Selection**: When creating a new pledge, users can:
    - Select an existing pledge from a dropdown (prefills all fields from that pledge)
    - Choose "Create New Pledge" option to enter a new pledge name
  - The pledge name input field only appears when "Create New Pledge" is selected
  - Supports editing existing pledges (form prefills with pledge data when `initialData` is provided)
  - Modal title changes to "Edit Pledge" when editing
  - When editing, the form shows all fields including the pledge name input

- **Contribution Form** (within Pledge Management Modal):
  - Includes contributor dropdown (optional) populated with all people from the database
  - Defaults to current date
  - Allows editing existing contributions via clickable table rows

### Data Loading & Updates

- On mount, the page parallel-fetches donations, offerings, pledges, weekly summary, and all pledge contributions for the selected date range
- When date range changes, all data is re-fetched automatically
- Successful form submissions prepend new records to local state and refresh relevant summary cards
- Errors surface via an error banner at the top of the page
- Loading states are managed per data type (donations, offerings, pledges, summary) for granular UI feedback

## Sample Data

A management command is available to populate the database with realistic finance data for development and testing:

```bash
cd backend
source venv/bin/activate
python manage.py populate_finance_data
```

Options:
- `--donations N` – Number of donations to create (default: 30)
- `--offerings N` – Number of weekly offerings to create (default: 12)
- `--pledges N` – Number of pledges to create (default: 8)
- `--clear` – Clear existing finance data before populating

The command creates:
- **Donations**: 
  - Varied purposes (Tithe, Offering, Building Fund, Missions, Youth Ministry, etc.)
  - Payment methods: Cash, Check, Bank Transfer, Card, Digital Wallet
  - Receipt numbers in `REC-` format (e.g., `REC-001000`, `REC-001001`)
  - Dates spread over the last 6 months
  - 30% are anonymous, 70% have donors linked to existing people
- **Offerings**: Weekly offerings spread over the past 12 weeks (mostly Sunday services), with amounts typically between ₱5,000–₱50,000. Some offerings have optional fund designations.
- **Pledges**: 
  - Multiple pledges with 1-6 contributions each
  - Includes active, fulfilled, and cancelled statuses
  - Pledge amounts range from ₱10,000–₱200,000
  - Contributions include:
    - **Contributor field**: 70% have same person as pledger, 30% have different person or no contributor
    - Automatic total calculation and pledge status updates

**Important Notes:**
- Ensure you have people in the database first (run `populate_sample_data` if needed) as the command uses them as donors, pledgers, and recorders.
- **Date Filtering**: Since donations are created with random dates over the past 6 months, if the Finance page defaults to "This Month", you may not see all sample donations initially. Use the date range selector to view "This Year" or "Last 6 Months" to see all generated data.
- The command automatically finds the highest existing receipt number and continues from there to avoid duplicates when run multiple times.

## Django Admin

All finance models are registered in Django admin (`apps.finance.admin`):

- **DonationAdmin**: List display shows receipt number, amount, date, purpose, recorded_by. Filterable by date, payment method, and anonymous status.
- **OfferingAdmin**: List display shows service_date, service_name, fund, amount, recorded_by. Filterable by service_date and fund.
- **PledgeAdmin**: List display shows pledge_title, pledger, pledge_amount, amount_received, status, target_date. Filterable by status.
- **PledgeContributionAdmin**: List display shows pledge, amount, contribution_date, recorded_by, created_at. Filterable by contribution_date, pledge, and recorded_by. Includes date hierarchy for easy navigation. Searchable by pledge title and notes.

## Testing

- `apps.finance.tests` includes coverage for pledge contribution roll-ups and the contribution API flow (create → list → delete). Extend these tests as the workflow evolves.
- When adding further coverage, prioritise:
  - Donation/Offering/Pledge CRUD including audit fields
  - Weekly offering and pledge summary actions (with date/status filters)
  - Serializer helper fields (`recorded_by_name`, `contributor_name`, balance, progress percent)
  - Contribution update functionality (PUT/PATCH)
  - Contributor field behavior and relationships
  - Offering update functionality (PUT)
  - Pledge update functionality (PUT)
  - Date range filtering for all endpoints
- Run finance tests with SQLite settings to avoid Postgres permissions:

```bash
cd backend
source venv/bin/activate
python manage.py test apps.finance --settings=core.settings_test
```

Extend the suite with fixtures covering anonymous donations, multi-week offerings, and partial/fulfilled pledges so dashboards remain trustworthy.




